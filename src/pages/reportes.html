<!DOCTYPE html>
<html lang="es" dir="ltr" data-sidebar="dark">
<head>
  {{> title-meta title="Reportes" }}
  {{> head-css }}
  <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.0/dist/apexcharts.min.js"></script>
</head>
<body class="vertical" x-data="reportes()">
  <div class="vertical lg:flex">
    {{> sidebar }}
    <div class="main-container w-full">
      {{> topbar }}
      <div class="main-content p-5 space-y-5">
        
        <!-- Page Header -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h1 class="text-3xl font-bold text-fenalco-blue">Reportes</h1>
            <p class="text-gray-600 mt-1">Análisis y métricas de desempeño</p>
          </div>
          <button class="btn btn-green" @click="exportPDF()">
            <i class="ri-download-line"></i> Descargar PDF
          </button>
        </div>

        <!-- Filter Section -->
        <div class="card">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Período</label>
              <select class="form-input" @change="loadReports()">
                <option value="7">Últimos 7 días</option>
                <option value="30">Últimos 30 días</option>
                <option value="90">Últimos 90 días</option>
                <option value="365">Este año</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Área</label>
              <select class="form-input" @change="loadReports()">
                <option value="">Todas</option>
                <option value="diseño">Diseño</option>
                <option value="creatividad">Creatividad</option>
                <option value="digital">Digital</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
              <select class="form-input" @change="loadReports()">
                <option value="">Todos</option>
                <option value="completed">Completadas</option>
                <option value="pending">Pendientes</option>
                <option value="in_progress">En Progreso</option>
              </select>
            </div>
            <div class="flex items-end">
              <button class="btn btn-green w-full">
                <i class="ri-search-line"></i> Filtrar
              </button>
            </div>
          </div>
        </div>

        <!-- Key Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
          <div class="card bg-gradient-to-br from-fenalco-green to-fenalco-turquoise">
            <p class="text-white/80 text-sm font-medium">Total Solicitudes</p>
            <h3 class="text-3xl font-bold text-white mt-2" x-text="metrics?.total || 0"></h3>
            <p class="text-white/70 text-xs mt-4">
              <i class="ri-arrow-up-line text-fenalco-yellow"></i> <span x-text="metrics?.totalGrowth || '0'">12%</span> vs período anterior
            </p>
          </div>

          <div class="card bg-gradient-to-br from-fenalco-sky to-fenalco-turquoise">
            <p class="text-white/80 text-sm font-medium">Tasa de Completitud</p>
            <h3 class="text-3xl font-bold text-white mt-2"><span x-text="metrics?.completionRate || 0"></span>%</h3>
            <div class="w-full bg-white/20 rounded-full h-2 mt-4">
              <div class="bg-white rounded-full h-2" :style="{ width: (metrics?.completionRate || 0) + '%' }"></div>
            </div>
          </div>

          <div class="card bg-gradient-to-br from-fenalco-yellow to-fenalco-orange">
            <p class="text-white/80 text-sm font-medium">Tiempo Promedio</p>
            <h3 class="text-3xl font-bold text-white mt-2"><span x-text="metrics?.avgTime || 0"></span>d</h3>
            <p class="text-white/70 text-xs mt-4">
              Días para completar
            </p>
          </div>

          <div class="card bg-gradient-to-br from-fenalco-coral to-fenalco-magenta">
            <p class="text-white/80 text-sm font-medium">Pendientes Críticas</p>
            <h3 class="text-3xl font-bold text-white mt-2" x-text="metrics?.criticalPending || 0"></h3>
            <p class="text-white/70 text-xs mt-4">
              <i class="ri-alert-line"></i> Requieren atención
            </p>
          </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
          <!-- Solicitudes por Mes -->
          <div class="card">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Solicitudes por Mes</h3>
            <div id="monthlyChart" class="h-64"></div>
          </div>

          <!-- Distribución por Prioridad -->
          <div class="card">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Distribución por Prioridad</h3>
            <div id="priorityChart" class="h-64"></div>
          </div>

          <!-- Solicitudes por Área -->
          <div class="card">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Solicitudes por Área</h3>
            <div id="areaChart" class="h-64"></div>
          </div>

          <!-- Tiempo de Resolución -->
          <div class="card">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Tiempo de Resolución</h3>
            <div id="resolutionChart" class="h-64"></div>
          </div>
        </div>

        <!-- Top Designers -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
          <div class="card">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Top Diseñadores</h3>
            <div class="space-y-3">
              <template x-for="designer in topDesigners" :key="designer.id">
                <div class="flex items-center justify-between pb-3 border-b border-gray-200 last:border-b-0">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-fenalco-green/20 flex items-center justify-center">
                      <i class="ri-user-line text-fenalco-green"></i>
                    </div>
                    <div>
                      <p class="font-medium text-gray-800 text-sm" x-text="designer.name"></p>
                      <p class="text-xs text-gray-500" x-text="`${designer.completed} completadas`"></p>
                    </div>
                  </div>
                  <span class="text-sm font-bold text-fenalco-green" x-text="`${designer.completed}`"></span>
                </div>
              </template>
            </div>
          </div>

          <div class="card">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Áreas más Solicitadas</h3>
            <div class="space-y-3">
              <template x-for="area in topAreas" :key="area.id">
                <div class="flex items-center justify-between pb-3 border-b border-gray-200 last:border-b-0">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full" :style="{ backgroundColor: area.color + '30' }" style="flex-shrink: 0;">
                      <i class="w-full h-full flex items-center justify-center" :style="{ color: area.color }" class="ri-folder-line"></i>
                    </div>
                    <p class="font-medium text-gray-800 text-sm" x-text="area.name"></p>
                  </div>
                  <div class="text-right">
                    <p class="font-bold text-sm" :style="{ color: area.color }" x-text="area.count"></p>
                    <p class="text-xs text-gray-500" x-text="`${area.percentage}%`"></p>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>

      </div>
      {{> footer }}
    </div>
  </div>

  {{> vendor-scripts }}
  <script>
    function reportes() {
      return {
        metrics: {},
        topDesigners: [],
        topAreas: [],

        async init() {
          await this.loadReports();
          this.initCharts();
        },

        async loadReports() {
          try {
            const response = await fetch('http://localhost:5000/api/reports', {
              headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
              }
            });
            const data = await response.json();
            this.metrics = data.metrics || {};
            this.topDesigners = data.topDesigners || [];
            this.topAreas = data.topAreas || [];
          } catch (error) {
            console.error('Error loading reports:', error);
          }
        },

        initCharts() {
          // Monthly Chart
          const monthlyOptions = {
            chart: { type: 'line', fontFamily: 'Cerebri Sans', foreColor: '#94989a' },
            colors: ['#00CE7C', '#009CDE'],
            series: [
              { name: 'Solicitudes', data: [12, 15, 8, 20, 18, 25, 22] },
              { name: 'Completadas', data: [8, 12, 6, 18, 15, 23, 20] }
            ],
            xaxis: { categories: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'] },
            stroke: { curve: 'smooth', width: 2 }
          };
          new ApexCharts(document.querySelector('#monthlyChart'), monthlyOptions).render();

          // Priority Chart
          const priorityOptions = {
            chart: { type: 'donut', fontFamily: 'Cerebri Sans', foreColor: '#94989a' },
            colors: ['#FF8674', '#FFB549', '#00CE7C'],
            series: [35, 45, 20],
            labels: ['Alta', 'Media', 'Baja'],
            legend: { position: 'bottom' }
          };
          new ApexCharts(document.querySelector('#priorityChart'), priorityOptions).render();

          // Area Chart
          const areaOptions = {
            chart: { type: 'bar', fontFamily: 'Cerebri Sans', foreColor: '#94989a' },
            colors: ['#2CD5C4'],
            series: [{ data: [28, 18, 15, 10] }],
            xaxis: { categories: ['Diseño', 'Creatividad', 'Digital', 'Otros'] },
            dataLabels: { enabled: false }
          };
          new ApexCharts(document.querySelector('#areaChart'), areaOptions).render();

          // Resolution Chart
          const resolutionOptions = {
            chart: { type: 'area', fontFamily: 'Cerebri Sans', foreColor: '#94989a' },
            colors: ['#00CE7C'],
            series: [{ data: [5, 4, 6, 3, 7, 4, 5] }],
            xaxis: { categories: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4', 'Sem 5', 'Sem 6', 'Sem 7'] },
            fill: { type: 'gradient' }
          };
          new ApexCharts(document.querySelector('#resolutionChart'), resolutionOptions).render();
        },

        exportPDF() {
          alert('Funcionalidad de exportación PDF en desarrollo');
        }
      }
    }
  </script>
</body>
</html>
